<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Classroom Monitor System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #4B5563;
            border-radius: 3px;
        }

        #resizable-camera-wrapper {
            position: relative;
            width: 100%;
            max-width: 100%;
            aspect-ratio: 16 / 9;
            resize: both;
            overflow: hidden;
            border: 4px solid #374151;
        }

        #resizable-camera-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-sans">
    <div class="flex flex-col lg:flex-row">
        <!-- Camera section -->
        <div class="flex-1 p-6 bg-black">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl text-purple-300 font-bold flex items-center gap-2">
                    Classroom Monitor System
                </h2>
            </div>
            <div id="resizable-camera-wrapper" class="mx-auto">
                <img src="{{ url_for('processed_video_feed') }}" alt="Processed video feed" id="video-feed">
            </div>
        </div>

        <div class="w-full lg:w-80 bg-gray-800 p-4 overflow-y-auto border-t lg:border-t-0 lg:border-l border-gray-700">
            <!-- Swapped positions: Capture All Detected Faces now comes first -->
            <button onclick="captureFace()"
                class="mb-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Capture All Detected Faces</button>

            <!-- Swapped positions: View Attendance History now comes second -->
            <a href="{{ url_for('attendance_page') }}" class="mb-4 w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 block text-center">
                View Attendance History
            </a>

            <!-- Card View for Roll Call -->
            <div class="bg-gray-700 p-4 rounded-lg shadow-md mb-6">
                <label for="interval" class="block text-sm font-medium text-gray-300">Roll Call Interval (minutes):</label>
                <input type="number" id="interval" name="interval" min="1" value="5"
                    class="mt-1 block w-full bg-gray-600 text-white border-gray-500 rounded-md shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50">
                <button onclick="startAttendance()"
                    class="mt-4 w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Start Attendance</button>
            </div>

            <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">Student List</h3>
            <p class="text-sm text-gray-500">Max Recognizable People: {{ current_recognized_people }}/{{ max_recognizable_people }}</p>
            <ul id="student-list" class="space-y-3">
                {% for student in students %}
                <li data-sid="{{ student.sid }}"
                    class="bg-gray-700 p-3 rounded-lg flex gap-3 items-center shadow hover:bg-gray-600 transition cursor-pointer"
                    onclick="selectStudent('{{ student.sid }}')">
                    <img src="{{ url_for('static', filename=student.avatar) }}"
                        class="w-12 h-12 object-cover border-2 border-white" alt="Student avatar">
                    <div>
                        <div class="font-bold text-lg">{{ student.name }}</div>
                        <div class="text-sm text-gray-300">ID: {{ student.sid }}</div>
                        <div class="text-sm text-gray-400">Dept: {{ student.dept }}</div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="p-6 bg-gray-100 text-gray-900">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">AI Detected Faces (To Pair)</h3>
        <div id="face-list" class="flex flex-wrap gap-6">
            {% if unpaired_faces %}
            {% for face in unpaired_faces %}
            <div id="face-card-{{ face.label }}"
                class="bg-white text-black rounded-lg shadow-md p-4 w-52 text-center hover:shadow-lg transition cursor-pointer">
                <img src="/{{ face.filepath }}" class="w-24 h-24 mx-auto object-cover border-4 border-purple-400 mb-2"
                    alt="Detected face">
                <button onclick="pairFace('{{ face.label }}')"
                    class="mt-2 w-full bg-purple-600 text-white py-1 rounded hover:bg-purple-700">
                    Pair
                </button>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-gray-500">No unpaired faces detected.</p>
            {% endif %}
        </div>
    </div>

    <script>
        let selectedStudent = null;

        function selectStudent(sid) {
            selectedStudent = sid;
            document.querySelectorAll('#student-list li').forEach(li => li.classList.remove('bg-purple-600'));
            document.querySelector(`#student-list li[data-sid="${sid}"]`).classList.add('bg-purple-600');
        }

        function pairFace(face) {
            if (!selectedStudent) {
                alert('Please select a student first!');
                return;
            }
            fetch("{{ url_for('pair') }}", {
                method: "POST",
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ image: face, student_sid: selectedStudent })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`face-card-${face}`).remove();
                        const studentItem = document.querySelector(`#student-list li[data-sid="${selectedStudent}"]`);
                        studentItem.querySelector('img').src = `{{ url_for('static', filename='thumbnails/') }}${face}`;
                        selectedStudent = null;
                        document.querySelectorAll('#student-list li').forEach(li => li.classList.remove('bg-purple-600'));
                        document.getElementById('video-feed').src = "{{ url_for('processed_video_feed') }}";
                    }
                })
                .catch(error => {
                    console.error('Error during pairing:', error);
                    alert('An error occurred while pairing. Please try again.');
                });
        }

        function manualCapture(sid, event) {
            event.stopPropagation();
            fetch("{{ url_for('manual_capture_route') }}", {
                method: "POST",
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ student_sid: sid })
            })
                .then(response => {
                    if (response.ok) {
                        console.log(`Manual capture triggered for student ${sid}`);
                        document.getElementById('video-feed').src = "{{ url_for('processed_video_feed') }}";
                    } else {
                        throw new Error('Manual capture failed');
                    }
                })
                .catch(error => {
                    console.error('Error during manual capture:', error);
                    alert('An error occurred during manual capture. Please try again.');
                });
        }

        function captureFace() {
            fetch("{{ url_for('capture_face') }}", {
                method: "POST",
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({})
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Captured ${data.captured_faces} unique unknown faces!`);
                        fetchUnpairedFaces();
                    } else {
                        alert('Capture failed: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error during capture:', error);
                    alert('An error occurred while capturing. Please try again.');
                });
        }

        function fetchUnpairedFaces() {
            fetch('/get_unpaired_faces')
                .then(response => response.json())
                .then(data => {
                    const faceList = document.getElementById('face-list');
                    faceList.innerHTML = '';
                    if (data.unpaired_faces.length > 0) {
                        data.unpaired_faces.forEach(face => {
                            const faceCard = `
                    <div id="face-card-${face.label}" class="bg-white text-black rounded-lg shadow-md p-4 w-52 text-center hover:shadow-lg transition cursor-pointer">
                        <img src="/${face.filepath}" class="w-24 h-24 mx-auto object-cover border-4 border-purple-400 mb-2" alt="Detected face">
                        <button onclick="pairFace('${face.label}')" class="mt-2 w-full bg-purple-600 text-white py-1 rounded hover:bg-purple-700">
                            Pair
                        </button>
                    </div>`;
                            faceList.innerHTML += faceCard;
                        });
                    } else {
                        faceList.innerHTML = '<p class="text-gray-500">No unpaired faces detected.</p>';
                    }
                });
        }

        function startAttendance() {
            const interval = document.getElementById('interval').value;
            fetch("{{ url_for('start_attendance') }}", {
                method: "POST",
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ interval: interval })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Attendance recorded!\nInterval: ${data.interval} minutes\nStudents present: ${data.recognized_count}`);
                        document.querySelectorAll('#student-list li').forEach(li => {
                            const sid = li.dataset.sid;
                            if (data.recognized_students.includes(sid)) {
                                li.classList.add('bg-green-600');
                            } else {
                                li.classList.remove('bg-green-600');
                            }
                        });
                    } else {
                        alert('Failed to start attendance: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error during attendance:', error);
                    alert('An error occurred while starting attendance. Please try again.');
                });
        }
    </script>
</body>
</html>